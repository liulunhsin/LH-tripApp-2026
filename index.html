<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taiwan Trip - Sync Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ⚠️ 在這裡填入你剛剛複製的 Firebase Config ⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyBYnROoZixE4LbeOlbxXCOs9TUUxHy8qn0",
            authDomain: "taiwantrip2026-b1e8f.firebaseapp.com",
            databaseURL: "https://taiwantrip2026-b1e8f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taiwantrip2026-b1e8f",
            storageBucket: "taiwantrip2026-b1e8f.firebasestorage.app",
            messagingSenderId: "692934699626",
            appId: "1:692934699626:web:f86c1f01a864ee5391b813"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const { createApp, ref: vRef, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const lang = vRef('zh');
                const activeTab = vRef('itinerary');
                const selectedDay = vRef(1);
                const isSyncing = vRef(true);
                const exchangeRate = vRef(24.2); // 預設 1 SGD = 24.2 TWD
                
                const itinerary = vRef([]);
                const expenses = vRef([]);
                const newExp = vRef({ name: '', amt: null, currency: 'TWD' });

                // Firebase 引用位置
                const dbItinerary = ref(db, 'itinerary');
                const dbExpenses = ref(db, 'expenses');

                onMounted(() => {
                    // 1. 同步行程數據
                    onValue(dbItinerary, (snapshot) => {
                        const val = snapshot.val();
                        itinerary.value = val ? Object.values(val) : [];
                        isSyncing.value = false;
                        refreshIcons();
                    });

                    // 2. 同步分帳數據
                    onValue(dbExpenses, (snapshot) => {
                        const val = snapshot.val();
                        expenses.value = val ? Object.values(val) : [];
                    });

                    // 3. 獲取新加坡幣匯率 (SGD to TWD)
                    fetch('https://open.er-api.com/v6/latest/SGD')
                        .then(r => r.json()).then(d => exchangeRate.value = d.rates.TWD.toFixed(2));
                });

                // --- 行程功能 ---
                const addItem = () => {
                    const newRef = push(dbItinerary);
                    set(newRef, { id: newRef.key, day: selectedDay.value, time: '10:00', loc: '', note: '' });
                };

                const updateItem = (item) => {
                    update(ref(db, `itinerary/${item.id}`), item);
                };

                const deleteItem = (id) => {
                    if(confirm('確定要刪除這個行程嗎？朋友那邊也會同步刪除喔！')) {
                        remove(ref(db, `itinerary/${id}`));
                    }
                };

                // --- 分帳功能 ---
                const addExpense = () => {
                    if(!newExp.value.name || !newExp.value.amt) return;
                    // 將外幣轉換為 SGD 存儲
                    const rate = newExp.value.currency === 'SGD' ? 1 : exchangeRate.value;
                    const sgdAmt = newExp.value.amt / rate;
                    
                    const newRef = push(dbExpenses);
                    set(newRef, {
                        id: newRef.key,
                        payer: newExp.value.name,
                        amount: newExp.value.amt,
                        currency: newExp.value.currency,
                        sgdAmt: sgdAmt
                    });
                    newExp.value = { name: '', amt: null, currency: 'TWD' };
                };

                const removeExpense = (id) => remove(ref(db, `expenses/${id}`));

                // --- 計算屬性 ---
                const filteredItinerary = computed(() => {
                    return itinerary.value.filter(i => i.day === selectedDay.value).sort((a,b) => a.time.localeCompare(b.time));
                });

                const totalSgd = computed(() => expenses.value.reduce((s, e) => s + e.sgdAmt, 0));

                const settlements = computed(() => {
                    const bal = {}; 
                    expenses.value.forEach(e => bal[e.payer] = (bal[e.payer] || 0) + e.sgdAmt);
                    const names = Object.keys(bal); if(names.length < 2) return [];
                    const avg = totalSgd.value / names.length;
                    let d = [], c = [];
                    names.forEach(n => {
                        let diff = bal[n] - avg;
                        if(diff > 0) c.push({n, amt: diff});
                        else if(diff < 0) d.push({n, amt: Math.abs(diff)});
                    });
                    let res = [], i = 0, j = 0;
                    while(i < d.length && j < c.length) {
                        let p = Math.min(d[i].amt, c[j].amt);
                        res.push({from: d[i].n, to: c[j].n, amt: p.toFixed(2)});
                        d[i].amt -= p; c[j].amt -= p;
                        if(d[i].amt < 0.01) i++; if(c[j].amt < 0.01) j++;
                    }
                    return res;
                });

                const refreshIcons = () => setTimeout(() => lucide.createIcons(), 50);
                watch([activeTab, selectedDay], refreshIcons);

                return { 
                    lang, activeTab, selectedDay, isSyncing, itinerary, filteredItinerary, 
                    addItem, updateItem, deleteItem, expenses, newExp, addExpense, removeExpense, 
                    totalSgd, settlements, exchangeRate 
                };
            }
        }).mount('#app');
    </script>

    <style>
        .lake-teal { background-color: #438E82; }
        .date-active { background-color: #438E82; color: white; transform: scale(1.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
        
        <div v-if="isSyncing" class="absolute inset-0 bg-white/90 z-[100] flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-xs tracking-widest text-emerald-800">與旅伴同步中...</p>
        </div>

        <header class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-light tracking-tighter text-slate-800">Taiwan Trip <span class="text-[10px] text-emerald-600 ml-2">● LIVE</span></h1>
                <button @click="addItem" class="lake-teal text-white p-2 rounded-full shadow-lg active:scale-90 transition-transform"><i data-lucide="plus"></i></button>
            </div>
            
            <div class="flex overflow-x-auto hide-scrollbar gap-4 py-2 text-center">
                <div v-for="n in 7" :key="n" @click="selectedDay = n"
                     :class="selectedDay === n ? 'date-active shadow-md' : 'bg-slate-50 text-slate-300'"
                     class="flex-shrink-0 w-12 h-16 rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer">
                    <span class="text-[8px] uppercase">Day</span>
                    <span class="text-lg font-bold">{{n}}</span>
                </div>
            </div>
        </header>

        <main class="flex-1 px-6 pb-32 overflow-y-auto">
            <div v-if="activeTab === 'itinerary'" class="space-y-4">
                <div v-for="item in filteredItinerary" :key="item.id" class="p-5 bg-white border border-slate-50 rounded-[2rem] shadow-sm group">
                    <div class="flex justify-between items-center mb-2">
                        <input type="time" v-model="item.time" @change="updateItem(item)" class="text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg outline-none">
                        <button @click="deleteItem(item.id)" class="text-slate-200 group-hover:text-red-300 transition-colors">✕</button>
                    </div>
                    <input v-model="item.loc" @blur="updateItem(item)" placeholder="輸入地點名稱" class="w-full text-base font-normal outline-none bg-transparent">
                </div>
            </div>

            <div v-if="activeTab === 'split'" class="space-y-6">
                <div class="lake-teal p-8 rounded-[2.5rem] text-white shadow-xl">
                    <p class="text-[10px] opacity-60 uppercase tracking-widest mb-1">Total (SGD)</p>
                    <h2 class="text-4xl font-light tracking-tighter mb-2">S$ {{ totalSgd.toFixed(2) }}</h2>
                    <p class="text-[10px] opacity-40 italic font-light">1 SGD ≈ {{exchangeRate}} TWD</p>
                </div>

                <div class="bg-slate-50 p-5 rounded-3xl space-y-3">
                    <div class="flex gap-2">
                        <input v-model="newExp.name" placeholder="付款人" class="flex-1 bg-white p-3 rounded-xl text-sm outline-none">
                        <select v-model="newExp.currency" class="bg-white p-3 rounded-xl text-xs outline-none">
                            <option value="TWD">TWD</option>
                            <option value="SGD">SGD</option>
                        </select>
                    </div>
                    <input v-model.number="newExp.amt" type="number" placeholder="金額" class="w-full bg-white p-3 rounded-xl text-sm outline-none">
                    <button @click="addExp" class="w-full bg-slate-800 text-white py-4 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-lg active:scale-95 transition-all">新增支出紀錄</button>
                </div>

                <div class="space-y-2">
                    <div v-for="s in settlements" class="flex justify-between items-center p-4 bg-emerald-50/50 rounded-2xl">
                        <span class="text-xs font-medium">{{s.from}} → {{s.to}}</span>
                        <span class="font-bold text-emerald-800 text-sm">S$ {{s.amt}}</span>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-6 right-6 max-w-md mx-auto h-16 rounded-full bg-white/90 backdrop-blur-md shadow-2xl border border-white/50 flex justify-around items-center px-10 z-50">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-emerald-700' : 'text-slate-300'"><i data-lucide="map"></i></button>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'text-emerald-700' : 'text-slate-300'"><i data-lucide="wallet"></i></button>
        </nav>
    </div>
</body>
</html>
